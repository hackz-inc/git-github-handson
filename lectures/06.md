# こんな時どうする

## 【目次】

1. [はじめに](#はじめに)
2. [add を取り消したい](#addを取り消したい)
3. [特定のコミットまで戻したい](#特定のコミットまで戻したい)
4. [間違えてコードを reset してしまった](#間違えてコードを-reset-してしまった)
5. [先に進んでいる別ブランチを反映させたい](#先に進んでいる別ブランチを反映させたい)
6. [コンフリクトが起きた時](#コンフリクトが起きた時)
7. [変更ファイルがあるから pull できない](#変更ファイルがあるからpullできない)
8. [間違えて別のブランチにコミットしてしまった](#間違えて別のブランチにコミットしてしまった)
9. [リモートブランチが先に進んでいる場合](#リモートブランチが先に進んでいる場合)
10. [環境変数や秘密鍵をコミットしてしまった](#環境変数や秘密鍵をコミットしてしまった)
11. [間違えてマージしてしまった](#間違えてマージしてしまった)
12. [PR のコミット分けろって怒られた](#PRのコミット分けろって怒られた)
13. [さいごに](#さいごに)

## 【はじめに】

ここでは、個人開発やチーム開発などでよく起こる「こんな時どうする」ということの解決方法とコマンドの説明をしていきます。

とにかく解決したい！と言う場合にはチートシートを用意しているので、こちらをご覧ください。 // TODO: リンクを追加

## 【add を取り消したい】

まだ編集が完了していないのに、add してしまった。  
add する予定のないファイルまで add してしまった。

などなど、add を取り消したい時は少なくありません。

安心してください。add を取り消したい時には以下のコマンドを実行するだけで大丈夫です。

```bash
// 全てのadd取り消す
$ git reset HEAD
or
$ git reset

// 特定のファイルのみ取り消す
$ git reset HEAD [ファイルのパス]
or
$ git reset [ファイルのパス]
```

`reset`コマンドはデフォルトで`HEAD`が指定されるため、`HEAD`は付けても付けなくても OK です。

`HEAD`とは一言で言うならば自分が今作業をしている場所のポインタです。  
つまり、現在自分が今いるブランチの最新のコミットを表しています。

log で履歴を見てみると、現在のブランチの最新のコミットに HEAD と示されていることが確認できます。

```bash
// mainブランチでlog
$ git log
----------------------------------------------------------------------------
commit 808c1b847fbc245cd17b31122ad12140610a5cf2 (HEAD -> main, origin/main)
Merge: 527161f 87b2c04
Author: Takeru  Miki <take.cantik17@gmail.com>
Date:   Mon Dec 12 11:04:52 2022 +0900

    Merge pull request #1 from take-cantik/test-1

    hello関数の作成

commit 87b2c04297cd7a356d08899f58d1e6070e7ad7b6 (origin/test-1, test-1)
Author: take-cantik <take.cantik17@gmail.com>
Date:   Sun Dec 11 19:13:39 2022 +0900

    Update: delete test and add hello func

commit 527161f482b839ecf8658b6135a1f09f69640eab
Author: take-cantik <take.cantik17@gmail.com>
Date:   Mon Dec 5 01:19:43 2022 +0900

    Update: README
```

```bash
// test-1ブランチでlog
$ git log
----------------------------------------------------------------------------
commit 87b2c04297cd7a356d08899f58d1e6070e7ad7b6 (HEAD -> test-1, origin/test-1)
Author: take-cantik <take.cantik17@gmail.com>
Date:   Sun Dec 11 19:13:39 2022 +0900

    Update: delete test and add hello func

commit 527161f482b839ecf8658b6135a1f09f69640eab
Author: take-cantik <take.cantik17@gmail.com>
Date:   Mon Dec 5 01:19:43 2022 +0900

    Update: README

commit 7b2ea0f4d20df2a0623b2e06f74eaf7e54d1e2ed
Author: take-cantik <take.cantik17@gmail.com>
Date:   Mon Dec 5 01:19:19 2022 +0900

    Add: test func
```

次に`reset`コマンドですが、このコマンドには大きく以下の二つの機能を持ちます。

1. インデックスを任意の状態に変更
2. HEAD を指定したコミットに移動

今回は 1 番目の機能を使用しています。

つまり、

```bash
$ git reset HEAD
```

を行うと、インデックスの状態を HEAD と同じ状態に戻す。つまり、add したものが削除されると言うことになります。

ここで、注意する点があります。  
それはファイル削除の add をファイル指定で HEAD を付けずに reset しようとした時です。

ワーキングツリーにファイルがない場合にはパスが見つからないと怒られてしまいます。

```bash
$ git reset index.js
-----------------------------------------------------------------------------------------
fatal: ambiguous argument 'index.js': unknown revision or path not in the working tree.
Use '--' to separate paths from revisions, like this:
'git <command> [<revision>...] -- [<file>...]'
 ~/works/hackz/test/test-app
```

しかし、第二引数に`HEAD`を入れると問題なく元に戻すことができます。

```bash
$ git reset HEAD index.js
----------------------------------------
Unstaged changes after reset:
D index.js
```

なんとなくで覚えていると詰まる時もあるので、常に`HEAD`をつけることを意識するとなんの問題もありません。

また、`git init`直後の`HEAD`が存在しないタイミングでの add を取り消したい場合には以下のコマンドを実行します。

```bash
// 全てのaddを取り消す
$ git rm --cached -r .

// 特定のファイルのaddを取り消す
$ git rm --cached [ファイルのパス]
```

`rm`コマンドは、ワークツリーとインデックスからファイルを削除するコマンドです。

これを行うとファイルも消えてしまうのですが、`--cached`を指定することによりファイルをインデックスのみから削除できるようになります。  
また、`-r`を指定するとディレクトリをまとめて削除することが可能になります。

## 【特定のコミットまで戻したい】

間違えてコミットしてしまった。  
実装はしたが、コードが不要になってしまった。

など、ある場所までコミットを戻したい時があると思います。

コミットを戻す時は主に以下の２つの方法があります。

- `reset`コマンド
- `revert`コマンド

### reset コマンドでコミットを戻す

reset コマンドを使うと**コミットをなかったこと**に出来ます。  
つまり、コミット自体を削除してしまいます。  
ですのでコミットログは見やすくなると言うメリットがあります。

しかしこのやり方には注意点があります。  
リモートリポジトリに`push`したコミットに対して行うと、不具合が発生してしまいます。
コミットそのものを削除してしまうので、既に取り消したコミットの上にさらに誰かがコミットしている場合に、  
存在するはずの親コミットがなくなってしまい、push することができなくなってしまいます。

したがって、`reset`コマンドを使用する場合には、**まだリモートに push していないローカルのみのコミット、または自分しか手をつけていないブランチのコミットのみに使用**するようにしてください。

使い方は以下の通りです。

```bash
// ワークツリーとインデックスはそのままにしたい時
$ git reset --soft [戻りたいコミットのID]

// ワーキングツリーはそのままでコミットを戻したい時
$ git reset --mixed [戻りたいコミットのID]

// 全てを戻したい時
$ git reset --hard [戻りたいコミットのID]
```

コミットの ID は`log`コマンドで出力される英数字の羅列となります。

reset のオプションについては以下の通りです。

`--soft`を指定すると、コミットのみが取り消されます。  
つまり、それまでのファイルの変更や add した内容はそのままになります。  
このオプションはまだコミットする予定がないのにコミットしてしまった時や、コミットするファイルを間違えてしまった時などに使うと便利なものです。

`--mixed`を指定すると、コミットとインデックスの中身も削除します、  
ちなみにオプション指定なしだとデフォルトでこのオプションがつきます。  
add 取り消しの時に `$ git reset HEAD` をしたと思いますが、このコマンドで add が取り消されるのは最後のコミットまでインデックスも戻すからということになります。

`--hard`を指定すると、ワークツリーもインデックスも元に戻ります。  
つまり、指定したコミットをした時の状態に戻るといった感じです。  
このオプションはコミットの内容がいらなくなった時などに使用します。

### revert コマンドでコミットを戻す

コミットを戻したい時にもう 1 つのやり方として`revert`コマンドがあります。

このコマンドは、コミットと逆の内容のコミットを作成するコマンドです。  
`revert`はコミットを取り消すのではなく、逆操作のコミットを追加するだけなのでリモートへ push 済みのコミットを`revert`しても問題はありません。

`revert`のログが残るのでログが少し汚くなるというデメリットもありますが、  
`revert`の方が安全に元に戻したり、`revert`の`revert`もできるので個人的にはこちらの方がオススメです。

使い方は以下の通りです。

```bash
$ git revert [取り消したいコミットのID]
```

このコマンドを実行するとエディタが開かれるので、保存すれば OK です。

また、マージ済みの Pull Request を Revert することもできます。  
以下のようにクローズされた Pull Request の「Revert」ボタンを選択すると、  
Pull Request を revert した Pull Request を作成することが可能です。

// TODO: 画像の追加 \* 2

## 【間違えてコードを reset してしまった】

## 【先に進んでいる別ブランチを反映させたい】

## 【コンフリクトが起きた時】

## 【変更ファイルがあるから pull できない】

## 【間違えて別のブランチにコミットしてしまった】

## 【リモートブランチが先に進んでいる場合】

## 【環境変数や秘密鍵をコミットしてしまった】

## 【間違えてマージしてしまった】

## 【PR のコミット分けろって怒られた】

## 【さいごに】

これ以外にもこんな場合の解決方法が欲しいという場合には、Issue に書いてください！

[前の資料](05.md) [次の資料](06.md)
